<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YourPuzzle - Caccia al Tesoro</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    h1 {
      margin: 20px;
    }

    #intro {
      text-align: center;
      max-width: 600px;
      margin: 10px;
      font-size: 1em;
      line-height: 1.4em;
    }

    #progressContainer {
      width: 90vw;
      max-width: 600px;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    #progressBar {
      height: 12px;
      background: #6b5ce0;
      width: 0%;
      transition: width 0.3s ease;
    }

    #puzzle-container {
      display: grid;
      gap: 1px;
      background-image: url(https://plus.unsplash.com/premium_photo-1692897457026-49e4e8d2393e?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8aXNvbGElMjBkZWwlMjB0ZXNvcm98ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&q=60&w=500');
      background-size: cover;
      background-position: center;
      overflow: auto;
      touch-action: none;
      width: 90vw;
      height: 70vh;
      max-width: 1200px;
      max-height: 800px;
    }

    .tile {
      background-color: rgba(0,0,0,0.7);
      cursor: pointer;
      width: calc(90vw / 100);
      height: calc(90vw / 100);
      min-width: 5px;
      min-height: 5px;
      position: relative;
      transition: background-color 0.2s;
    }

    .tile.revealed {
      background-color: transparent;
      cursor: default;
    }

    .nickname {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      color: #fff;
      font-size: 0.6em;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      animation: fadeIn 0.6s ease forwards;
    }

    .treasure {
      font-size: 1em;
      color: gold;
      animation: glow 1.5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 5px #ff0, 0 0 10px gold; }
      to { text-shadow: 0 0 15px #ffea00, 0 0 30px gold; }
    }

    @keyframes fadeIn {
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <h1>YourPuzzle - Caccia al Tesoro</h1>
  <div id="intro">
    Benvenuto su <strong>YourPuzzle</strong>!<br>
    Ogni giorno c‚Äô√® un <strong>tesoro nascosto</strong> in una delle tessere.<br>
    <ul>
      <li><strong>Una sola mossa al giorno</strong>: scegli con attenzione quale tessera scoprire.</li>
      <li>Se trovi il tesoro, puoi lasciare il tuo <strong>nickname</strong> in sovrimpressione, visibile fino a mezzanotte.</li>
      <li>La barra di progresso mostra quanto del puzzle √® stato esplorato dagli utenti di oggi.</li>
    </ul>
    Buona fortuna! üîç‚≠ê
  </div>
  <div id="progressContainer"><div id="progressBar"></div></div>
  <div id="puzzle-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "INSERISCI_API_KEY",
      authDomain: "INSERISCI_AUTH_DOMAIN",
      databaseURL: "INSERISCI_DATABASE_URL",
      projectId: "INSERISCI_PROJECT_ID",
      storageBucket: "INSERISCI_STORAGE_BUCKET",
      messagingSenderId: "INSERISCI_MESSAGING_SENDER_ID",
      appId: "INSERISCI_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ROWS = 100;
    const COLS = 100;
    const TOTAL = ROWS * COLS;
    const container = document.getElementById("puzzle-container");
    container.style.gridTemplateColumns = `repeat(${COLS}, 1fr)`;
    const progressBar = document.getElementById("progressBar");

    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("userId", userId);
    }

    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const tile = document.createElement("div");
        tile.classList.add("tile");
        tile.dataset.row = r;
        tile.dataset.col = c;
        tile.addEventListener("click", () => revealTile(r, c, tile));
        container.appendChild(tile);
      }
    }

    const treasureRef = ref(db, "treasure/today");
    async function initTreasure() {
      await runTransaction(treasureRef, (current) => {
        if (!current) {
          const row = Math.floor(Math.random() * ROWS);
          const col = Math.floor(Math.random() * COLS);
          return { row, col };
        }
        return;
      });
      const snap = await get(treasureRef);
      return snap.val();
    }

    let treasurePos = null;
    initTreasure().then(pos => { treasurePos = pos; });

    let dbSnapshot = {};

    async function revealTile(row, col, tileEl) {
      if (tileEl.classList.contains("revealed")) return;

      const todayKey = new Date().toISOString().slice(0, 10);
      const userClickRef = ref(db, `users/${userId}/lastClick`);
      const snapshot = await get(userClickRef);
      if (snapshot.exists() && snapshot.val() === todayKey) return;

      runTransaction(ref(db, `tiles/${row}_${col}`), (current) => {
        if (!current) return true;
      });

      set(userClickRef, todayKey);

      if (treasurePos && treasurePos.row == row && treasurePos.col == col) {
        const nick = prompt("üéâ Hai trovato il tesoro! Inserisci il tuo nickname:");
        if (nick) {
          const nickRef = ref(db, `treasure/nicknames/${todayKey}`);
          set(nickRef, { row, col, nick });
          const span = document.createElement("div");
          span.classList.add("nickname", "treasure");
          span.textContent = nick + " ‚≠ê";
          tileEl.appendChild(span);
        }
      }
    }

    onValue(ref(db, "tiles"), (snap) => {
      dbSnapshot = snap.val() || {};
      const revealedCount = Object.keys(dbSnapshot).length;
      for (let key in dbSnapshot) {
        const [r, c] = key.split("_");
        const tileEl = document.querySelector(`.tile[data-row='${r}'][data-col='${c}']`);
        if (tileEl) tileEl.classList.add("revealed");
      }
      progressBar.style.width = (revealedCount / TOTAL * 100) + "%";
    });

    onValue(ref(db, "treasure/nicknames"), (snap) => {
      const data = snap.val() || {};
      const todayKey = new Date().toISOString().slice(0, 10);
      if (data[todayKey]) {
        const { row, col, nick } = data[todayKey];
        const tileEl = document.querySelector(`.tile[data-row='${row}'][data-col='${col}']`);
        if (tileEl && !tileEl.querySelector(".nickname")) {
          const span = document.createElement("div");
          span.classList.add("nickname", "treasure");
          span.textContent = nick + " ‚≠ê";
          tileEl.appendChild(span);
          tileEl.classList.add("revealed");
        }
      }
    });
  </script>
</body>
</html>
